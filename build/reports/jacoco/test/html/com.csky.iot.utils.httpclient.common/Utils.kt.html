<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Utils.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cop-console</a> &gt; <a href="index.source.html" class="el_package">com.csky.iot.utils.httpclient.common</a> &gt; <span class="el_source">Utils.kt</span></div><h1>Utils.kt</h1><pre class="source lang-java linenums">package com.csky.iot.utils.httpclient.common


import com.alibaba.fastjson.JSONObject
import com.csky.iot.utils.LogUtil
import org.apache.http.HttpEntity
import org.apache.http.NameValuePair
import org.apache.http.entity.ByteArrayEntity
import org.apache.http.entity.ContentType
import org.apache.http.entity.FileEntity
import org.apache.http.entity.StringEntity
import org.apache.http.message.BasicHeader
import org.apache.http.protocol.HTTP
import java.io.File
import java.io.UnsupportedEncodingException
import java.lang.reflect.Field
import java.lang.reflect.Modifier
import java.util.*
import java.util.HashMap


<span class="nc" id="L22">object Utils {</span>

    //浼犲叆鍙傛暟鐗瑰畾绫诲瀷
<span class="nc" id="L25">    val ENTITY_STRING = &quot;\$ENTITY_STRING$&quot;</span>
<span class="nc" id="L26">    val ENTITY_FILE = &quot;\$ENTITY_FILEE$&quot;</span>
<span class="nc" id="L27">    val ENTITY_BYTES = &quot;\$ENTITY_BYTES$&quot;</span>
<span class="nc" id="L28">    val ENTITY_INPUTSTREAM = &quot;\$ENTITY_INPUTSTREAM$&quot;</span>
<span class="nc" id="L29">    val ENTITY_SERIALIZABLE = &quot;\$ENTITY_SERIALIZABLE$&quot;</span>
<span class="nc" id="L30">    val ENTITY_MULTIPART = &quot;\$ENTITY_MULTIPART$&quot;</span>
<span class="nc" id="L31">    private val SPECIAL_ENTITIY = Arrays.asList(ENTITY_STRING, ENTITY_BYTES, ENTITY_FILE, ENTITY_INPUTSTREAM, ENTITY_SERIALIZABLE, ENTITY_MULTIPART)</span>

    /**
     * 鏄惁寮�鍚痙ebug锛�
     */
    private var debug = false

    /**
     * 妫�娴媢rl鏄惁鍚湁鍙傛暟锛屽鏋滄湁锛屽垯鎶婂弬鏁板姞鍒板弬鏁板垪琛ㄤ腑

     * @param url                    璧勬簮鍦板潃
     * *
     * @param nvps                鍙傛暟鍒楄〃
     * *
     * @return    杩斿洖鍘绘帀鍙傛暟鐨剈rl
     * *
     * @throws UnsupportedEncodingException
     */
    @Throws(UnsupportedEncodingException::class)
    fun checkHasParas(url: String): String {
<span class="nc" id="L51">        var _url = url</span>
        // 妫�娴媢rl涓槸鍚﹀瓨鍦ㄥ弬鏁�
<span class="nc bnc" id="L53" title="All 4 branches missed.">        if (_url.contains(&quot;?&quot;) &amp;&amp; _url.indexOf(&quot;?&quot;) &lt; _url.indexOf(&quot;=&quot;)) {</span>
<span class="nc" id="L54">            _url = _url.substring(0, _url.indexOf(&quot;?&quot;))</span>
        }
<span class="nc" id="L56">        return _url</span>
    }

    /**
     * 鍙傛暟杞崲锛屽皢map涓殑鍙傛暟锛岃浆鍒板弬鏁板垪琛ㄤ腑

     * @param nvps                鍙傛暟鍒楄〃
     * *
     * @param map                鍙傛暟鍒楄〃锛坢ap锛�
     * *
     * @throws UnsupportedEncodingException
     */
    @Throws(UnsupportedEncodingException::class)
    fun map2HttpEntity(map: MutableMap&lt;String, Any&gt;?, encoding: String): HttpEntity? {
<span class="nc" id="L70">        var entity: HttpEntity ?= null</span>
<span class="nc" id="L71">        val jsonObject : JSONObject = JSONObject()</span>
<span class="nc bnc" id="L72" title="All 4 branches missed.">        if (map != null &amp;&amp; map.size &gt; 0) {</span>
<span class="nc" id="L73">            var isSpecial = false</span>
            // 鎷兼帴鍙傛暟
<span class="nc bnc" id="L75" title="All 2 branches missed.">            for ((key, value) in map) {</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">                if (SPECIAL_ENTITIY.contains(key)) {//鍒ゆ柇鏄惁鍦ㄤ箣涓�</span>
<span class="nc" id="L77">                    isSpecial = true</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">                    if (ENTITY_STRING == key) {//string</span>
<span class="nc" id="L79">                        entity = StringEntity(value.toString(), encoding)</span>
<span class="nc" id="L80">                        break</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">                    } else if (ENTITY_BYTES == key) {//file</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">                        entity = ByteArrayEntity(value as ByteArray)</span>
<span class="nc" id="L83">                        break</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">                    } else if (ENTITY_FILE == key) {//file</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                        if (File::class.java.isAssignableFrom(value.javaClass)) {</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">                            entity = FileEntity(value as File, ContentType.APPLICATION_OCTET_STREAM)</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">                        } else if (value.javaClass == String::class.java) {</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                            entity = FileEntity(File(value as String), ContentType.create(&quot;text/plain&quot;, &quot;UTF-8&quot;))</span>
                        }
<span class="nc" id="L90">                        break</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">                    } else if (ENTITY_INPUTSTREAM == key) {//inputstream</span>
                        //						entity = new InputStreamEntity();
<span class="nc" id="L93">                        break</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">                    } else if (ENTITY_SERIALIZABLE == key) {//serializeable</span>
                        //						entity = new SerializableEntity()
<span class="nc" id="L96">                        break</span>
                    }  else {
<span class="nc" id="L98">                        jsonObject.put(key, value.toString())</span>
                        //nvps.add(BasicNameValuePair(key, value.toString()))
<span class="nc" id="L100">                    }</span>
                } else {
<span class="nc" id="L102">                    jsonObject.put(key, value.toString())</span>
                    //nvps.add(BasicNameValuePair(key, value.toString()))
                }
            }
<span class="nc bnc" id="L106" title="All 2 branches missed.">            if (!isSpecial) {</span>

<span class="nc" id="L108">                entity =  StringEntity(jsonObject.toString(),  ContentType.create(&quot;application/json&quot;, encoding))</span>
                //entity = UrlEncodedFormEntity(nvps, encoding)
            }
        }
<span class="nc" id="L112">        return entity</span>
    }

    /**
     * @param encoding
     * *
     * @param entity
     */
    private fun removeContentTypeChraset(encoding: String, entity: HttpEntity) {
<span class="nc" id="L121">        try {</span>
<span class="nc" id="L122">            val clazz = entity.javaClass</span>
<span class="nc" id="L123">            val field = clazz.getDeclaredField(&quot;contentType&quot;)</span>
<span class="nc" id="L124">            field.isAccessible = true //灏嗗瓧娈电殑璁块棶鏉冮檺璁句负true锛氬嵆鍘婚櫎private淇グ绗︾殑褰卞搷</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">            if (Modifier.isFinal(field.modifiers)) {</span>
<span class="nc" id="L126">                val modifiersField = Field::class.java.getDeclaredField(&quot;modifiers&quot;) //鍘婚櫎final淇グ绗︾殑褰卞搷锛屽皢瀛楁璁句负鍙慨鏀圭殑</span>
<span class="nc" id="L127">                modifiersField.isAccessible = true</span>
<span class="nc" id="L128">                modifiersField.setInt(field, field.modifiers and Modifier.FINAL.inv())</span>
            }
<span class="nc bnc" id="L130" title="All 2 branches missed.">            field.set(entity, BasicHeader(HTTP.CONTENT_TYPE, (field.get(entity) as BasicHeader).value.replace(&quot;; charset=&quot; + encoding, &quot;&quot;)))</span>
<span class="nc" id="L131">        } catch (e: NoSuchFieldException) {</span>
<span class="nc" id="L132">            LogUtil.e(javaClass, e.message.toString())</span>
<span class="nc" id="L133">        } catch (e: SecurityException) {</span>
<span class="nc" id="L134">            LogUtil.e(javaClass, e.message.toString())</span>
<span class="nc" id="L135">        } catch (e: IllegalArgumentException) {</span>
<span class="nc" id="L136">            LogUtil.e(javaClass, e.message.toString())</span>
<span class="nc" id="L137">        } catch (e: IllegalAccessException) {</span>
<span class="nc" id="L138">            LogUtil.e(javaClass, e.message.toString())</span>
        }
<span class="nc" id="L140">    }</span>


    /**
     * 鐢熸垚鍙傛暟
     * 鍙傛暟鏍煎紡鈥渒1=v1&amp;k2=v2鈥�

     * @param paras                鍙傛暟鍒楄〃
     * *
     * @return                        杩斿洖鍙傛暟鍒楄〃锛坢ap锛�
     */
    fun buildParas(paras: String): MutableMap&lt;String, Any&gt; {
<span class="nc bnc" id="L152" title="All 4 branches missed.">        val p = paras.split(&quot;&amp;&quot;.toRegex()).dropLastWhile { it.isEmpty() }.toTypedArray()</span>
<span class="nc" id="L153">        val ps = Array&lt;Array&lt;String?&gt;&gt;(p.size) { arrayOfNulls&lt;String&gt;(2) }</span>
        var pos : Int?
<span class="nc bnc" id="L155" title="All 2 branches missed.">        for (i in p.indices) {</span>
<span class="nc" id="L156">            pos = p[i].indexOf(&quot;=&quot;)</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            ps[i][0] = p[i].substring(0, pos)</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">            ps[i][1] = p[i].substring(pos + 1)</span>
        }
<span class="nc" id="L160">        return buildParas(ps)</span>
    }

    /**
     * 鐢熸垚鍙傛暟
     * 鍙傛暟绫诲瀷锛歿{&quot;k1&quot;,&quot;v1&quot;},{&quot;k2&quot;,&quot;v2&quot;}}

     * @param paras                鍙傛暟鍒楄〃
     * *
     * @return                        杩斿洖鍙傛暟鍒楄〃锛坢ap锛�
     */
    fun buildParas(paras: Array&lt;Array&lt;String?&gt;&gt;): MutableMap&lt;String, Any&gt; {
        // 鍒涘缓鍙傛暟闃熷垪
<span class="nc" id="L173">        val map = HashMap&lt;String, Any&gt;()</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">        for (para in paras) {</span>
<span class="nc bnc" id="L175" title="All 4 branches missed.">            map.put(para[0]!!, para[1]!!)</span>
        }
<span class="nc" id="L177">        return map</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>