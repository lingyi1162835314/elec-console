<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HCB.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cop-console</a> &gt; <a href="index.source.html" class="el_package">com.csky.iot.utils.httpclient.builder</a> &gt; <span class="el_source">HCB.kt</span></div><h1>HCB.kt</h1><pre class="source lang-java linenums">package com.csky.iot.utils.httpclient.builder

import com.csky.iot.utils.httpclient.exception.HttpProcessException
import java.io.InterruptedIOException
import java.net.UnknownHostException

import javax.net.ssl.SSLException
import javax.net.ssl.SSLHandshakeException

import org.apache.http.HttpEntityEnclosingRequest
import org.apache.http.HttpHost
import org.apache.http.NoHttpResponseException
import org.apache.http.client.HttpRequestRetryHandler
import org.apache.http.client.config.RequestConfig
import org.apache.http.client.protocol.HttpClientContext
import org.apache.http.conn.ConnectTimeoutException
import org.apache.http.conn.socket.ConnectionSocketFactory
import org.apache.http.conn.socket.PlainConnectionSocketFactory
import org.apache.http.impl.client.HttpClientBuilder
import org.apache.http.impl.conn.DefaultProxyRoutePlanner
import org.apache.http.impl.conn.PoolingHttpClientConnectionManager
import org.apache.http.config.RegistryBuilder

<span class="nc" id="L24">class HCB internal constructor() : HttpClientBuilder() {</span>

<span class="nc" id="L26">    var isSetPool = false//璁板綍鏄惁璁剧疆浜嗚繛鎺ユ睜</span>

    fun custom(): HCB {
<span class="nc" id="L29">        return HCB()</span>
    }

    /**
     * 璁剧疆瓒呮椂鏃堕棿浠ュ強鏄惁鍏佽缃戦〉閲嶅畾鍚戯紙鑷姩璺宠浆 302锛�

     * @param timeout        瓒呮椂鏃堕棿锛屽崟浣�-姣
     * *
     * @param redirectEnable        鑷姩璺宠浆
     * *
     * @return
     */
    @JvmOverloads fun timeout(timeout: Int, redirectEnable: Boolean = true): HCB {
        // 閰嶇疆璇锋眰鐨勮秴鏃惰缃�
<span class="nc" id="L43">        val config = RequestConfig.custom().setConnectionRequestTimeout(timeout).setConnectTimeout(timeout).setSocketTimeout(timeout).setRedirectsEnabled(redirectEnable).build()</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">        return this.setDefaultRequestConfig(config) as HCB</span>
    }

    /**
     * 璁剧疆杩炴帴姹狅紙榛樿寮�鍚痟ttps锛�

     * @param maxTotal                    鏈�澶ц繛鎺ユ暟
     * *
     * @param defaultMaxPerRoute    姣忎釜璺敱榛樿杩炴帴鏁�
     * *
     * @return
     * *
     * @throws HttpProcessException
     */
    @Throws(HttpProcessException::class)
    fun pool(maxTotal: Int, defaultMaxPerRoute: Int): HCB {
<span class="nc" id="L60">        val socketFactoryRegistry = RegistryBuilder.create&lt;ConnectionSocketFactory&gt;().register(&quot;http&quot;, PlainConnectionSocketFactory.INSTANCE).build()</span>
        //璁剧疆杩炴帴姹犲ぇ灏�
<span class="nc" id="L62">        val connManager = PoolingHttpClientConnectionManager(socketFactoryRegistry)</span>
<span class="nc" id="L63">        connManager.maxTotal = maxTotal// Increase max total connection to $maxTotal</span>
<span class="nc" id="L64">        connManager.defaultMaxPerRoute = defaultMaxPerRoute// Increase default max connection per route to $defaultMaxPerRoute</span>
        //connManager.setMaxPerRoute(route, max);// Increase max connections for $route(eg锛歭ocalhost:80) to 50
<span class="nc" id="L66">        isSetPool = true</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">        return this.setConnectionManager(connManager) as HCB</span>
    }

    /**
     * 璁剧疆浠ｇ悊

     * @param hostOrIP        浠ｇ悊host鎴栬�卛p
     * *
     * @param port            浠ｇ悊绔彛
     * *
     * @return
     */
    fun proxy(hostOrIP: String, port: Int): HCB {
        // 渚濇鏄唬鐞嗗湴鍧�锛屼唬鐞嗙鍙ｅ彿锛屽崗璁被鍨�
<span class="nc" id="L81">        val proxy = HttpHost(hostOrIP, port, &quot;http&quot;)</span>
<span class="nc" id="L82">        val routePlanner = DefaultProxyRoutePlanner(proxy)</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        return this.setRoutePlanner(routePlanner) as HCB</span>
    }

//    /**
//     * 閲嶈瘯锛堝鏋滆姹傛槸骞傜瓑鐨勶紝灏卞啀娆″皾璇曪級
//
//     * @param tryTimes                        閲嶈瘯娆℃暟
//     * *
//     * @param retryWhenInterruptedIO        杩炴帴鎷掔粷鏃讹紝鏄惁閲嶈瘯
//     * *
//     * @return
//     */
//    @JvmOverloads fun retry(tryTimes: Int, retryWhenInterruptedIO: Boolean = false): HCB {
//        // 璇锋眰閲嶈瘯澶勭悊
//        val httpRequestRetryHandler = HttpRequestRetryHandler { exception, executionCount, context -&gt;
//            if (executionCount &gt;= tryTimes) {// 濡傛灉宸茬粡閲嶈瘯浜唍娆★紝灏辨斁寮�
//                return@HttpRequestRetryHandler false
//            }
//            if (exception is NoHttpResponseException) {// 濡傛灉鏈嶅姟鍣ㄤ涪鎺変簡杩炴帴锛岄偅涔堝氨閲嶈瘯
//                return@HttpRequestRetryHandler true
//            }
//            if (exception is SSLHandshakeException) {// 涓嶈閲嶈瘯SSL鎻℃墜寮傚父
//                return@HttpRequestRetryHandler false
//            }
//            if (exception is InterruptedIOException) {// 瓒呮椂
//                //return false;
//                return@HttpRequestRetryHandler retryWhenInterruptedIO
//            }
//            if (exception is UnknownHostException) {// 鐩爣鏈嶅姟鍣ㄤ笉鍙揪
//                return@HttpRequestRetryHandler true
//            }
//            if (exception is ConnectTimeoutException) {// 杩炴帴琚嫆缁�
//                return@HttpRequestRetryHandler false
//            }
//            if (exception is SSLException) {// SSL鎻℃墜寮傚父
//                return@HttpRequestRetryHandler false
//            }
//
//            val clientContext = HttpClientContext.adapt(context)
//            val request = clientContext.request as? HttpEntityEnclosingRequest ?: return@HttpRequestRetryHandler true
//            // 濡傛灉璇锋眰鏄箓绛夌殑锛屽氨鍐嶆灏濊瘯
//            false
//        }
//        this.setRetryHandler(httpRequestRetryHandler)
//        return this
//    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>